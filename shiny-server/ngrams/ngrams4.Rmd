---
title: "Ngrams"
runtime: shiny
output: 
html_document: 
fig_caption: yes
---

- This page allows you to examine and download 1- to 4-grams in various CHILDES corpus.  Scroll down to the bottom for more information.  Click [here](../toolkit/) to return to toolkit page.

```{r setup, include=FALSE}
library(shinycssloaders)
require(ggplot2)
ignore = "-----"

ngramdir = "storage/ngrams"


```

```{r, echo=FALSE}

shinyApp(
  ui =  fluidPage(
    sidebarPanel(selectInput("langGroup", "Language Group: ", 
                             choices = c(), width='90%')
                 ,selectInput("lang", "Language: ",
                              choices = c(),width='90%')
                 ,selectInput("corpus", "Corpus: ", 
                              choices = c(ignore),width='90%')
                 ,selectInput("ngram", "N-gram type", 
                              choices = c("1-gram","2-gram","3-gram","4-gram"), selected="unigram",width='90%')
                 ,downloadButton('downloadData', 'Download')
                 ,width = 3)
    ,mainPanel(withSpinner(DT::dataTableOutput("table", height = '400px')))
    ,plotOutput("logrank")
     ),
  server = function(input, output, session) {
    source('shared2.R', local=TRUE)
    values$updateFilter = TRUE
    dd <- readFileDir("Eng-NA","Bates","Free20")
    
    observeEvent(input$ngram, {
      if (!is.null(input$ngram)){
        loadCorpora()
      }
   })
    
    observeEvent(input$corpus, {
        loadCorpora()
    })
    
    getFileName <- function(nopath){
      gram = as.integer(str_split_fixed(input$ngram,"-",2)[1])
      fpath = paste(ngramdir, "/",input$langGroup,"_",input$lang,"_",input$corpus, "_",gram,".rds",sep="")
      if (input$lang == ignore | input$lang == ""){
        fpath = paste(ngramdir, "/",input$langGroup,"_",gram,".rds",sep="")
      }else{
        if (input$corpus == ignore | input$corpus == ""){
          fpath = paste(ngramdir, "/",input$langGroup,"_",input$lang,"_",gram,".rds",sep="")
        }
      }
      if (nopath){
        fpath = str_replace(fpath,paste(ngramdir,"/",sep=""),"")
      }
      print(fpath)
      return(fpath)
    }
    
    loadCorpora <- function(){
      fpath = getFileName(FALSE)
      print(fpath)
      if (file.exists(fpath)){
        print("found")
        values$table = readRDS(fpath)
      }
    }
    
    output$logrank<-renderPlot({
      if (length(values$table) > 2 & "rank" %in% names(values$table)){
        ngdf = values$table
        ngdf = ngdf[ngdf$punct == 0,]
         ggplot(ngdf,aes(x=logrank,y=logfreq))+geom_point(colour='red')+stat_smooth(method="lm")
      }
      })
    
    output$downloadData <- downloadHandler(
      filename = function() { 
        getFileName(TRUE)
      },
      content <- function(file) {
     #print(geturl)
#    file.copy(geturl,file)
    #download.file(geturl, destfile=file, method="auto")
        # file.copy(fpath,file)

        fpath = getFileName(FALSE)
         wholecsv <- readRDS(fpath)
           write.csv.utf8.BOM(wholecsv, file)

      }
      ,contentType = "text/csv"
    )
  }
  ,options = list(width=1000,height = 960)
)
```

- Zipf (1949) found that there was a negative linear relationship between log frequency and log rank in written texts, but larger natural spoken corpora do no always exhibit this relationship.  Punctuation words (e.g., #ppp = declarative, #qqq = questions, #eee = exclamation).
- This work is part of the toolkit project within the ESRC International Centre for Language and Communicative Development (LuCiD) (http://www.lucid.ac.uk/, ESRC grant [ES/L008955/1]).  Please contact Franklin Chang with any questions.
- To cite these tools, please use this reference: Chang, F. (2017) The LuCiD language researcher's toolkit [Computer software]. Retrieved from http://www.lucid.ac.uk/resources/for-researchers/toolkit/

